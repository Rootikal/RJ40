<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7Taskmaster Scoreboard2</title>
    <style>
        /* Add your CSS here (same as before) */
    </style>
</head>
<body>
    <div class="scoreboard" id="scoreboard">
        <div class="left-section" id="left-section"></div>
        <div class="right-section" id="right-section"></div>
    </div>

    <script>
        const sheetId = '1z4UHaz7ReS5LM56XsN2rqMDuAPaPHl6-rOCUJ3eNVKU';
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

        async function fetchScores() {
            try {
                const response = await fetch(sheetUrl);
                const data = await response.text();

                // Parse CSV data and split rows
                const rows = data.replace(/\r/g, '').split('\n').map(row => {
                    return row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)?.map(cell => cell.replace(/(^"|"$)/g, '').trim());
                }).filter(Boolean); // Filter out invalid rows

                if (rows.length < 2) {
                    throw new Error('No valid data found in the sheet.');
                }

                // Sort rows by score (column index 4)
                const sortedRows = rows.slice(1).sort((a, b) => parseFloat(b[4]) - parseFloat(a[4]));

                // Select sections
                const leftSection = document.getElementById('left-section');
                const rightSection = document.getElementById('right-section');
                leftSection.innerHTML = '';
                rightSection.innerHTML = '';

                // Add the top contestant to the right section
                const [topContestant, ...remainingContestants] = sortedRows;

                if (topContestant && topContestant.length >= 6) {
                    const [contestant, , , , total, url] = topContestant;

                    const largeImageDiv = document.createElement('div');
                    largeImageDiv.className = 'large-image';

                    const largeImg = document.createElement('img');
                    largeImg.src = url;
                    largeImg.alt = contestant;
                    largeImg.style.setProperty('--rotate-angle', `${Math.random() * 10 - 5}deg`);

                    const largeScore = document.createElement('div');
                    largeScore.className = 'large-score';
                    largeScore.textContent = total;

                    largeImageDiv.appendChild(largeImg);
                    largeImageDiv.appendChild(largeScore);

                    rightSection.appendChild(largeImageDiv);
                }

                // Helper to create contestant cards
                const createContestantDiv = ([contestant, , , , total, url]) => {
                    if (!contestant || !url || isNaN(total)) return null;

                    const contestantDiv = document.createElement('div');
                    contestantDiv.className = 'contestant';

                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = contestant;
                    img.style.setProperty('--rotate-angle', `${Math.random() * 10 - 5}deg`);

                    const score = document.createElement('div');
                    score.className = 'score';
                    score.textContent = total;

                    contestantDiv.appendChild(img);
                    contestantDiv.appendChild(score);
                    return contestantDiv;
                };

                // Add remaining contestants to the left section
                remainingContestants.forEach(row => {
                    const contestantDiv = createContestantDiv(row);
                    if (contestantDiv) leftSection.appendChild(contestantDiv);
                });
            } catch (error) {
                console.error('Error fetching or processing data:', error);
                alert('Failed to load the scoreboard. Please check the console for details.');
            }
        }

        fetchScores();
        setInterval(fetchScores, 5000);
    </script>
</body>
</html>
